<!DOCTYPE html>
<html ng-app="maisonConnecteeApp">
<head>
    <meta charset="UTF-8">
    <title>Maison Connectée</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body ng-controller="MainController">
	<!-- En-tête avec boutons -->
    <!-- Remplacez toute la section header par : -->
<div class="header">
    <!-- Non connecté -->
    <div ng-if="!isLoggedIn">
        
        <button ng-click="openLogin()">
            <i class="fas fa-sign-in-alt"></i> Se connecter
        </button>
        <button ng-click="redirectToInscription()">
            <i class="fas fa-user-plus"></i> S'inscrire
        </button>
    </div>
    
    <!-- Connecté -->
    <div ng-if="isLoggedIn" class="user-header">
	    <div class="user-info">
		   <span>Identifié en tant que : {{currentUser.pseudo}}</span>
		   <button ng-click="logout()" class="logout-btn">
		       <i class="fas fa-sign-out-alt"></i> Déconnexion
		   </button>
	    </div>
	    
	    <div class="rang-selector">
		   <span class="rang-label">Choix du profil :</span>
		   <select ng-model="selectedRang" 
			   ng-change="updateAccessLevel()"
			   ng-options="rang as rang for rang in availableRangs track by rang"
			   ng-value="selectedRang">
			</select>
		    
	    </div>
	</div>
</div>


    <!-- Contenu principal -->
    <div class="main-container">
        <!-- Section Météo -->
        <div class="weather-section">
            <h1 class="welcome-title">Bienvenue dans votre Maison Connectée</h1>
            <div class="weather-card" ng-if="weatherData">
                <h2><i class="fas fa-cloud-sun"></i> Météo</h2>
                <p>{{ weatherData.city }}</p>
                <img ng-src="{{ weatherData.iconUrl }}" class="weather-icon" alt="Conditions météo">
                <div class="temperature">{{ weatherData.temperature }}°C</div>
                <p>{{ weatherData.description }}</p>
                <div class="weather-details">
                    <p><i class="fas fa-wind"></i> Vent: {{ weatherData.windSpeed }} km/h</p>
                    <p><i class="fas fa-tint"></i> Humidité: {{ weatherData.humidity }}%</p>
                </div>
            </div>
            <div class="weather-card" ng-if="!weatherData">
                <h2><i class="fas fa-cloud-sun"></i> Météo</h2>
                <p>Chargement en cours...</p>
            </div>
        </div>

        <!-- Section Inventaire -->
        <div class="inventory-section">
            <h2 class="inventory-title"><i class="fas fa-laptop"></i> Inventaire des Matériels</h2>
            
            <!-- Barre de recherche avancée -->
            <div class="filtres-container">
                <!-- Filtre Lieu -->
                <div class="filtre-group">
                    <label for="lieu">Lieu</label>
                    <select id="lieu" ng-model="filters.lieu" ng-options="lieu for lieu in filtres.lieux">
                        <option value="">Tous les lieux</option>
                    </select>
                    <span ng-if="filters.lieu" class="active-filter">
                        {{filters.lieu}} <i class="fas fa-times" ng-click="filters.lieu=''"></i>
                    </span>
                </div>
                
                <!-- Filtre Type -->
                <div class="filtre-group">
                    <label for="type">Type</label>
                    <select id="type" ng-model="filters.type" ng-options="type for type in filtres.types">
                        <option value="">Tous les types</option>
                    </select>
                    <span ng-if="filters.type" class="active-filter">
                        {{filters.type}} <i class="fas fa-times" ng-click="filters.type=''"></i>
                    </span>
                </div>
                
                <!-- Filtre État -->
                <div class="filtre-group">
                    <label for="etat">État</label>
                    <select id="etat" ng-model="filters.etat" ng-options="etat for etat in filtres.etats">
                        <option value="">Tous les états</option>
                    </select>
                    <span ng-if="filters.etat" class="active-filter">
                        {{filters.etat}} <i class="fas fa-times" ng-click="filters.etat=''"></i>
                    </span>
                </div>
                
                <!-- Filtre Mots-clés -->
                <div class="filtre-group">
                    <label for="motsCles">Recherche texte</label>
                    <input id="motsCles" type="text" ng-model="filters.motsCles" placeholder="Nom, description ou mots-clés...">
                    <span ng-if="filters.motsCles" class="active-filter">
                        {{filters.motsCles}} <i class="fas fa-times" ng-click="filters.motsCles=''"></i>
                    </span>
                </div>
                
                <!-- Bouton Réinitialiser -->
                <button class="btn-reset" ng-click="resetFilters()">
                    <i class="fas fa-times"></i> Réinitialiser
                </button>
            </div>

            <!-- Message de chargement -->
            <div class="loading" ng-show="loading">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>
                Chargement de l'inventaire...
            </div>

            <!-- Tableau des objets -->
            <table ng-hide="loading">
                <thead>
                    <tr>
                        <th ng-click="sortBy('nom')">
                            Nom 
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'nom', 
                                         'fa-sort-up': sortField == 'nom' && !reverse, 
                                         'fa-sort-down': sortField == 'nom' && reverse}"></i>
                        </th>
                        <th ng-click="sortBy('description')">
                            Description
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'description', 
                                         'fa-sort-up': sortField == 'description' && !reverse, 
                                         'fa-sort-down': sortField == 'description' && reverse}"></i>
                        </th>
                        <th ng-click="sortBy('type')">
                            Type
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'type', 
                                         'fa-sort-up': sortField == 'type' && !reverse, 
                                         'fa-sort-down': sortField == 'type' && reverse}"></i>
                        </th>
                        <th ng-click="sortBy('etat')">
                            État 
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'etat', 
                                         'fa-sort-up': sortField == 'etat' && !reverse, 
                                         'fa-sort-down': sortField == 'etat' && reverse}"></i>
                        </th>
                        <th ng-click="sortBy('lieu')">
                            Lieu 
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'lieu', 
                                         'fa-sort-up': sortField == 'lieu' && !reverse, 
                                         'fa-sort-down': sortField == 'lieu' && reverse}"></i>
                        </th>
                        <th ng-click="sortBy('temperature')">
                            Température 
                            <i class="fas sort-icon" 
                               ng-class="{'fa-sort': sortField != 'temperature', 
                                         'fa-sort-up': sortField == 'temperature' && !reverse, 
                                         'fa-sort-down': sortField == 'temperature' && reverse}"></i>
                        </th>
                        					   <!-- Nouvelle colonne Actions -->
					<th ng-if="isLoggedIn" style="display: flex; justify-content: center; align-items: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="objet in filteredObjets = (objets | filter:customFilter | orderBy:sortField:reverse) | startFrom:currentPage*pageSize | limitTo:pageSize">
                        <td><strong>{{ objet.nom }}</strong></td>
                        <td class="description-cell" title="{{ objet.description }}">{{ objet.description }}</td>
                        <td>{{ objet.type }}</td>
                        <td>
                            <span ng-class="{
                                'status-active': objet.etat === 'Fonctionnel',
                                'status-inactive': objet.etat === 'Hors service',
                                'status-maintenance': objet.etat === 'En maintenance'
                            }">
                                <i class="fas fa-circle" style="font-size: 0.7em;"></i> {{ objet.etat }}
                            </span>
                        </td>
                        <td>{{ objet.lieu }}</td>
                        <td>{{ objet.temperature != null ? (objet.temperature + '°C') : 'N/A' }}</td>
					<td ng-if="isLoggedIn" class="actions-cell"> <!-- Visible seulement si connecté -->
						  <button ng-click="openAppareilPopup(objet, $event)" class="visualiser-btn">
							 <i class="fas fa-eye"></i> Visualiser
						  </button>
					</td>
                    </tr>
                    <tr ng-if="filteredObjets.length === 0">
                        <td colspan="5" style="text-align: center; padding: 20px; color: #7f8c8d;">
                            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            Aucun matériel ne correspond à vos critères de recherche
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" ng-hide="loading || filteredObjets.length <= pageSize">
                <button ng-disabled="currentPage == 0" ng-click="currentPage = currentPage - 1">
                    <i class="fas fa-chevron-left"></i> Précédent
                </button>
                <span class="pagination-info">Page {{ currentPage + 1 }} sur {{ numberOfPages() }}</span>
                <button ng-disabled="currentPage >= filteredObjets.length/pageSize - 1" ng-click="currentPage = currentPage + 1">
                    Suivant <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Popup de connexion -->
    <div class="popup-overlay" ng-show="showLoginPopup" ng-click="closeLogin()">
        <div class="login-popup" ng-click="$event.stopPropagation()">
            <button class="popup-close-btn" ng-click="closeLogin()">
                <i class="fas fa-times"></i>
            </button>
            <h2><i class="fas fa-key"></i> Connexion</h2>
            <form ng-submit="login()">
                <div class="form-group">
                    <label for="pseudo"><i class="fas fa-user"></i> Pseudo :</label>
                    <input type="text" id="pseudo" ng-model="user.pseudo" required placeholder="Votre pseudo">
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Mot de passe :</label>
                    <input type="password" id="password" ng-model="user.password" required placeholder="Votre mot de passe">
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Se connecter
                </button>
                <div class="error-message" ng-if="loginError">
                    <i class="fas fa-exclamation-circle"></i> {{ loginError }}
                </div>
            </form>
        </div>
    </div>

<!-- Popup d'appareil -->
<div class="popup-overlay" ng-show="showAppareilPopup" ng-click="closePopup()">
    <div class="appareil-popup" ng-click="$event.stopPropagation()">
        <button class="popup-close-btn" ng-click="closePopup()">
            <i class="fas fa-times"></i>
        </button>
        
        <h2>{{selectedAppareil.nom}}</h2>
        
        <div class="popup-body">
            <table class="popup-table">
                <tbody>
                    <tr>
                        <th>Nom</th>
                        <td>{{selectedAppareil.nom}}</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr>
                        <th>Description</th>
                        <td>{{selectedAppareil.description}}</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr>
                        <th>État</th>
                        <td>{{selectedAppareil.etat}}</td>
                        <td class="action-cell" ng-if="selectedRang === 'complexe' || selectedRang === 'admin'">
					    <div class="toggle-container">
						   <div class="toggle-slider" 
							   ng-class="{'active': selectedAppareil.etat === 'actif', 'inactive': selectedAppareil.etat === 'inactif'}" 
							   ng-click="toggleEtat()">
							  <div class="toggle-knob"></div>
							  <span class="toggle-label">{{selectedAppareil.etat === 'actif' ? 'ON' : 'OFF'}}</span>
						   </div>
					    </div>
					</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td>{{selectedAppareil.type}}</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr>
                        <th>Lieu</th>
                        <td>{{selectedAppareil.lieu}}</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr ng-if="selectedAppareil.temperature !== null">
                        <th>Température</th>
                        <td>{{selectedAppareil.temperature}}°C</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr ng-if="selectedAppareil.consigne !== null">
                        <th>Consigne</th>
                        <td>{{selectedAppareil.consigne}}°C</td>
                        <td class="action-cell">
                            <div class="consigne-control">
                                <input type="number" ng-model="selectedAppareil.newConsigne" 
                   ng-init="selectedAppareil.newConsigne = selectedAppareil.temperature"
                   class="consigne-input" step="0.5">
                                <button class="btn-validate" ng-click="updateConsigne()">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <tr ng-if="(selectedRang === 'complexe' || selectedRang === 'admin') && selectedAppareil.type === 'thermostat'">
                        <th>Limite haute</th>
                        <td>{{selectedAppareil.lim_haute}}°C</td>
                        <td class="action-cell"></td>
                    </tr>
                    <tr ng-if="(selectedRang === 'complexe' || selectedRang === 'admin') && selectedAppareil.type === 'thermostat'">
                        <th>Limite basse</th>
                        <td>{{selectedAppareil.lim_basse}}°C</td>
                        <td class="action-cell"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="popup-footer" ng-if="selectedRang === 'admin'">
		    <button class="btn-delete" ng-click="confirmDelete()">
			   <i class="fas fa-trash-alt"></i> Supprimer le matériel
		    </button>
	   </div>
        
    </div>
</div>




   <script src="scripts/app.js"></script>
</body>
</html>
